<?php
if (!defined("FUNC_FILE")) die("Illegal File Access");

$fav['charset']='utf-8'; #utf-8, windows-1251
include_once("config/config_favorites.php");
function favorite_view() { global $db,$prefix,$fav,$user,$conf; $num = isset($_GET['num'])?intval($_GET['num']):"1"; $i=($num-1)*$fav['num']; $result = $db->sql_query("SELECT `id`,`title`,`url` FROM ".$prefix."_myfavorite WHERE `uid`='".intval($user[0])."' ORDER BY `id` DESC LIMIT ".(($num-1)*$fav['num']).", ".$fav['num']); $count=$db->sql_numrows($db->sql_query("SELECT `id` FROM ".$prefix."_myfavorite WHERE `uid`='".intval($user[0])."'")); ob_start(); if ($conf['gzip']==1) ob_implicit_flush(0); warning(($count<$fav['max'])?_NEW_FAV_6.$fav['max']._NEW_FAV_7.$count._NEW_FAV_8.($fav['max']-$count):_NEW_FAV_6.$fav['max']._NEW_FAV_7.$count._NEW_FAV_9.($count-$fav['max']+1), '', '', ($count>=$fav['max'])?1:0); $out .= ob_get_contents(); ob_end_clean(); $out .="<div class='fvt_chkadd'><a href='#' class='button green medium' id='checkadd' onclick='favorite_add ({url:\"1\",title:\"1\"},\"\",{div:\"#result_favorite\",edit:\"0\"});return false;'>"._NEW_FAV_15."</a></div><div></div>"; if ($count==0) { $out .="<div class='clear'></div>"; ob_start(); if ($conf['gzip']==1) ob_implicit_flush(0); warning(_NEW_FAV_26, '', '', 0); $out .= ob_get_contents(); ob_end_clean(); } else { $out .="<div class='fvt_chkall'><a href='#' class='button white medium' id='checkall'>"._NEW_FAV_5."</a></div><div></div>"; $out .="<table width='100%' border='0' cellpadding='2' cellspacing='1' class='sort' id='sort_id'><tr><th>"._NEW_FAV_1."</th><th>"._NEW_FAV_2."</th><th>"._NEW_FAV_3."</th></tr>"; while (list($id,$title,$url) = $db->sql_fetchrow($result)) { if ($title=='') $title=_NEW_FAV_16; $i++; $out .="<tr class='bgcolor1'>" ."<td style='width:35px;' align='center'>$i</td>" ."<td><a href='$url' title='$title'>$title</a></td>" .'<td style="width:100px;" align="right" id="myfavedit"> <img src="/images/favorite/edit.png" border="0" alt="'._NEW_FAV_10.'" title="'._NEW_FAV_10.'" onclick="favorite_edit(\''.$id.'\');" align="center" style="cursor: pointer;"> <a href="'.$url.'" title="'.$title.'"><img src="/images/favorite/view.png" border="0" alt="'._NEW_FAV_4.'" title="'._NEW_FAV_4.'" align="center"></a> <a href="'.$url.'" title="'._NEW_FAV_11.'" onclick="return favorite_browser(this,\''.$url.'\',\''.$title.'\');"><img src="/images/favorite/browser.png" border="0" alt="'._NEW_FAV_11.'" title="'._NEW_FAV_11.'" align="center" style="cursor: pointer;"></a> <img src="/images/favorite/delete.png" border="0" alt="'._NEW_FAV_12.'" title="'._NEW_FAV_12.'" onclick="favorite_del(\''.$id.'\',\'#result_favorite\',1);" align="center" style="cursor: pointer;"> <input type="checkbox" class="checkbox favorite" name="delete[]" value="'.$id.'"> </td></tr>'; } $out .="</table>"; $out .="<div class='fvt_chkdel'><a href='#' class='button rosy medium' id='checkdel'>"._NEW_FAV_14."</a></div><div></div>"; ob_start(); if ($conf['gzip']==1) ob_implicit_flush(0); num_page($conf['name'],$count,ceil($count/$fav['num']),$fav['num'],"op=account_favorite&");  $out .= ob_get_contents(); ob_end_clean(); } return $out; }
function favorite_add($in) { global $db,$prefix,$fav,$user,$conf; $in['edit']=intval($_GET['edit']); include_once('function/template.php'); $in['url']=(isset($_GET['url']))?text_filter(trim($_GET['url'])):''; if ($in['url']!='' && !preg_match("~^(?:(?:https?|ftp|telnet)://(.*?))~i",$in['url'],$m)) $in['url']='http://'.$in['url']; $in['title']=(isset($_GET['title']))?text_filter($_GET['title']):''; if (!is_user()) { $out['status']=0; $out['text']=($in['edit']==0)?_NEW_FAV_17:_NEW_FAV_22; } elseif ($in['url']=='') { $out['status']=0; $out['text']=($in['edit']==0)?_NEW_FAV_18:_NEW_FAV_23; } else { if ($in['edit']==0) $count[1]=$db->sql_numrows($db->sql_query("SELECT `id` FROM ".$prefix."_myfavorite WHERE `uid`='".intval($user[0])."'")); $count[2]=$db->sql_numrows($db->sql_query("SELECT `id` FROM ".$prefix."_myfavorite WHERE `uid`='".intval($user[0])."' AND `url`='".$in['url']."'".(($in['edit']!=0)?" AND `id`!='".$in['edit']."'":''))); if ($in['edit']==0 && $count[1]>=$fav['max']) { $out['status']=0; $out['text']=_NEW_FAV_19; } elseif ($count[2]>0) { $out['status']=0; $out['text']=($in['edit']==0)?_NEW_FAV_20:_NEW_FAV_24; } else { if ($fav['charset']=='windows-1251') { $in['title']=iconv("UTF-8","windows-1251",$in['title']); $in['url']=iconv("UTF-8","windows-1251",$in['url']); } if ($in['edit']==0) $db->sql_query("INSERT INTO ".$prefix."_myfavorite (`id`,`uid`,`title`,`url`,`iid`,`mod`) VALUES (NULL, '".intval($user[0])."', '".$in['title']."', '".$in['url']."', '".$in['id']."','".(($in['mod']=='0')?'':$in['mod'])."')"); else $db->sql_query("UPDATE ".$prefix."_myfavorite SET `title`='".$in['title']."', `url`='".$in['url']."' WHERE `id`='".$in['edit']."'"); $out['status']=1; if ($in['id']==0) $out['html']=favorite_view(); else $out['html']=favorite_check(array('id'=>$in['id'],'mod'=>$in['mod'])); $out['text']=($in['edit']==0)?_NEW_FAV_21:_NEW_FAV_25; } } echo my_json_encode($out); }
function favorite_del() { global $db,$prefix,$user,$conf; include_once('function/template.php'); if (!is_user()) { $out['status']=0; $out['text']=_NEW_FAV_27; } else { $ids=explode(',',$_GET['ids']); array_walk($ids,create_function('&$a','$a=intval($a);')); $id=implode(',',$ids); $db->sql_query("DELETE FROM ".$prefix."_myfavorite WHERE `uid`='".intval($user[0])."' AND `".((intval($_GET['type'])==1)?'id':'iid')."` IN (".$id.")"); $out['status']=1; if (intval($_GET['type'])==1) $out['html']=favorite_view(); else {$arr=explode('-',text_filter($_GET['type']));$out['html']=favorite_check(array('id'=>$arr[1],'mod'=>$arr[0]));} $out['text']=_NEW_FAV_28; } echo my_json_encode($out); }
function favorite_edit() { global $db,$prefix,$user; if (!is_user()) $out['text']=_NEW_FAV_29; else { $result = $db->sql_query("SELECT `title`,`url`,`mod` FROM ".$prefix."_myfavorite WHERE `uid`='".intval($user[0])."' AND `id`='".intval($_GET['id'])."'"); list($out['title'],$out['url'],$out['mod']) = $db->sql_fetchrow($result); if (!$out['title']) $out['text']=_NEW_FAV_30; } echo my_json_encode($out); }
function favorite_fast () { global $db,$prefix,$user,$fav; header('Content-type: text/html; charset='.$fav['charset']); if (!is_user()) {echo '<br /><table class="favorite_fast"><caption>'._NEW_FAV_31.'</caption></table>'; exit();} $out=''; $i=1; $result=$db->sql_query("SELECT `title`,`url` FROM `".$prefix."_myfavorite` WHERE `uid`='".$user[0]."' ORDER BY `id` DESC LIMIT 0, 10"); while(list($title,$url) = $db->sql_fetchrow($result)) { if ($title=='') $title=_NEW_FAV_16; $out .='<tr'.(($i%2)?'':' class="odd"').'><td>'.$i.'</td><td class="alft"><a href="'.$url.'" title="'._NEW_FAV_32.'">'.$title.'</a></td></tr>'; $i++; } if (!$out) echo '<br /><table class="favorite_fast" summary="'._NEW_FAV_33.'"><caption>'._NEW_FAV_26.'</caption></table>'; else echo '<br /><table class="favorite_fast" summary="'._NEW_FAV_33.'"><caption>'._NEW_FAV_34.'</caption><thead><tr class="odd"><th class="col" abbr="'._NEW_FAV_35.'">'._NEW_FAV_1.'</th><th scope="col" abbr="'._NEW_FAV_13.'">'._NEW_FAV_13.'</th></tr></thead><tbody>'.$out.'</tbody></table>'; }
function favorite_check ($in=array(),$f=1,$cut=0) { global $chkfav,$user,$db,$prefix,$conf,$fav; if ($fav['mods'][$in['mod']]['active']==0 || $fav['mods'][$in['mod']]['cut']==1 && $cut==1) return ''; if (is_user()) { if (!is_array($chkfav[$in['mod']]) || $f!=1) { $chkfav[$in['mod']]=array(); $result=$db->sql_query("SELECT `iid` FROM `".$prefix."_myfavorite` WHERE `mod`='".$in['mod']."' AND `uid`='".$user[0]."'"); while (list($ids) = $db->sql_fetchrow($result)) $chkfav[$in['mod']][]=$ids; } if (in_array($in['id'],$chkfav[$in['mod']])) return "<span class='favorite_mod del' title='"._NEW_FAV_36."' onclick=\"favorite_del('".$in['id']."','#".$in['mod']."-".$in['id']."','".$in['mod']."-".$in['id']."');\">&nbsp;</span>"; else return "<span class='favorite_mod add' title='"._NEW_FAV_37."' onclick=\"favorite_add_mod('".$in['mod']."','".$in['id']."');\">&nbsp;</span>"; } }
function my_json_encode ($a) { global $fav; if ($fav['charset']=='windows-1251') { header('Content-type: text/html; charset='.$fav['charset']); foreach ($a as $b=>$c) $d[]='"'.$b.'":"'.addcslashes(str_replace(array("\r","\n"),"",$c), '"').'"'; return '{'.implode(',',$d).'}'; } else return json_encode($a); }
?>